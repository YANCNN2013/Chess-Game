<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户认证 - 国际象棋</title>
  <!-- 网站图标 -->
  <link rel="icon" href="icon.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="icon.jpg">
  <!-- 基础样式 - 确保在JavaScript禁用时也能正常工作 -->
  <style>
    /* 重置样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* 基础页面样式 */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #F5F5DC;
      color: #3E2723;
    }
    
    /* JavaScript禁用时的页面样式 */
    noscript {
      display: block;
    }
    
    /* 默认隐藏页面内容，当JavaScript启用时会显示 */
    #page-content {
      display: none;
    }
  </style>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8B4513',
            secondary: '#D2B48C',
            accent: '#CD853F',
            light: '#F5F5DC',
            dark: '#3E2723'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .auth-container {
        min-height: calc(100vh - 120px);
      }
      
      .auth-card {
        max-width: 400px;
        width: 100%;
      }
      
      .form-input {
        transition: all 0.3s ease;
      }
      
      .form-input:focus {
        box-shadow: 0 0 0 3px rgba(205, 133, 63, 0.3);
      }
      
      .tab-button {
        transition: all 0.3s ease;
      }
      
      .tab-button.active {
        border-bottom: 2px solid #8B4513;
        color: #8B4513;
      }
      
      /* 隐藏滚动条 */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
    }
  </style>
</head>
<body class="bg-light min-h-screen font-sans text-dark">
  <!-- JavaScript被禁用时的提示 -->
  <noscript>
    <div style="position: fixed; inset: 0; background: #3E2723; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: 10px; padding: 40px; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
        <div style="font-size: 60px; color: #CD853F; margin-bottom: 20px;">⚠️</div>
        <h1 style="font-size: 24px; font-weight: bold; color: #8B4513; margin-bottom: 15px;">JavaScript被禁用</h1>
        <p style="font-size: 16px; color: #666; margin-bottom: 30px; line-height: 1.6;">
          本国际象棋游戏需要启用JavaScript才能正常运行。
          请在浏览器设置中启用JavaScript，然后刷新页面。
        </p>
        <button style="background: #8B4513; color: white; border: none; border-radius: 6px; padding: 12px 30px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.3s;">
          刷新页面
        </button>
      </div>
    </div>
  </noscript>
  
  <!-- 页面内容包装器 - 默认隐藏，JavaScript启用时显示 -->
  <div id="page-content">
    <!-- 顶部导航 -->
    <nav class="bg-primary text-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <i class="fa fa-chess-board text-2xl"></i>
          <h1 class="text-xl font-bold">国际象棋</h1>
        </div>
        
        <!-- 桌面端菜单 -->
        <div class="hidden lg:flex space-x-4 items-center">
          <a href="index.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">首页</a>
          <a href="records.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">记录</a>
          <a href="profile.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">个人信息</a>
          <a href="download.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">下载</a>
          <a href="rules.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">规则</a>
          <a href="support.html" class="px-3 py-2 rounded hover:bg-accent transition-colors">支持</a>
          
          <!-- 用户认证/个人信息 -->
          <div id="user-auth" class="flex items-center space-x-2">
            <a href="auth.html" class="px-3 py-2 rounded bg-accent transition-colors active">登录</a>
          </div>
          <div id="user-profile" class="flex items-center space-x-2 hidden">
            <span id="username-display" class="px-3 py-2 rounded bg-accent">用户名</span>
            <button id="logout-button" class="px-3 py-2 rounded hover:bg-accent transition-colors">
              <i class="fa fa-sign-out"></i>
            </button>
          </div>
        </div>
        
        <!-- 移动端菜单按钮 -->
        <button id="mobile-menu-button" class="lg:hidden text-white focus:outline-none">
          <i class="fa fa-bars text-xl"></i>
        </button>
      </div>
      
      <!-- 移动端菜单 -->
      <div id="mobile-menu" class="hidden lg:hidden bg-primary/95 backdrop-blur-sm border-t border-white/20">
        <div class="container mx-auto px-4 py-2 space-y-1">
          <a href="index.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">首页</a>
          <a href="records.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">记录</a>
          <a href="profile.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">个人信息</a>
          <a href="download.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">下载</a>
          <a href="rules.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">规则</a>
          <a href="support.html" class="block px-3 py-2 rounded hover:bg-accent transition-colors">支持</a>
          
          <!-- 移动端用户认证/个人信息 -->
          <div id="mobile-user-auth" class="block px-3 py-2">
            <a href="auth.html" class="block px-3 py-2 rounded bg-accent transition-colors active">登录</a>
          </div>
          <div id="mobile-user-profile" class="hidden block px-3 py-2">
            <div class="flex justify-between items-center">
              <span id="mobile-username-display" class="px-3 py-2 rounded bg-accent">用户名</span>
              <button id="mobile-logout-button" class="px-3 py-2 rounded hover:bg-accent transition-colors">
                <i class="fa fa-sign-out"></i> 登出
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-8">
    <div class="auth-container flex items-center justify-center">
      <div class="auth-card bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- 标签页 -->
        <div class="flex border-b">
          <button id="login-tab" class="tab-button flex-1 py-4 px-6 text-center font-medium active">
            <i class="fa fa-sign-in mr-2"></i> 登录
          </button>
          <button id="register-tab" class="tab-button flex-1 py-4 px-6 text-center font-medium">
            <i class="fa fa-user-plus mr-2"></i> 注册
          </button>
        </div>
        
        <!-- 登录表单 -->
        <div id="login-form" class="p-6">
          <h2 class="text-2xl font-bold text-center mb-6 text-primary">用户登录</h2>
          
          <div class="space-y-4">
            <div>
              <label for="login-username" class="block mb-2 font-medium">用户名</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-user text-gray-400"></i>
                </span>
                <input type="text" id="login-username" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入用户名">
              </div>
            </div>
            
            <div>
              <label for="login-password" class="block mb-2 font-medium">密码</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-lock text-gray-400"></i>
                </span>
                <input type="password" id="login-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入密码">
              </div>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <input type="checkbox" id="remember-me" class="w-4 h-4 text-accent focus:ring-accent border-gray-300 rounded">
                <label for="remember-me" class="ml-2 text-sm text-gray-600">记住我</label>
              </div>
              <a href="#" class="text-sm text-accent hover:underline">忘记密码？</a>
            </div>
            
            <div>
              <label for="login-captcha" class="block mb-2 font-medium">验证码</label>
              <input type="text" id="login-captcha" class="form-input w-full mb-3 pl-4 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入验证码">
              <div class="flex justify-center">
                <canvas id="login-captcha-canvas" class="h-12 w-32 md:h-10 md:w-24 border border-gray-300 rounded-lg bg-light cursor-pointer"></canvas>
              </div>
            </div>
            
            <button id="login-button" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
              <i class="fa fa-sign-in mr-2"></i> 登录
            </button>
            
            <div class="mt-4 border-t pt-4">
              <div class="flex justify-center">
                <button id="auth-import-data-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                  <i class="fa fa-upload mr-2"></i> 导入用户数据
                </button>
              </div>
              <!-- 使用不同的方式隐藏文件输入框 -->
              <input type="file" id="auth-import-file-input" accept=".json" style="position: absolute; opacity: 0; width: 0; height: 0;">
              <p class="text-xs text-gray-500 mt-2 text-center">注意：导入数据将覆盖现有所有用户数据，请谨慎操作</p>
            </div>
          </div>
          
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              还没有账号？ <button id="switch-to-register" class="text-accent hover:underline font-medium">立即注册</button>
            </p>
          </div>
        </div>
        
        <!-- 注册表单 -->
        <div id="register-form" class="p-6 hidden">
          <h2 class="text-2xl font-bold text-center mb-6 text-primary">用户注册</h2>
          
          <div class="space-y-4">
            <div>
              <label for="register-username" class="block mb-2 font-medium">用户名</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-user text-gray-400"></i>
                </span>
                <input type="text" id="register-username" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入用户名">
              </div>
            </div>
            
            <div>
              <label for="register-email" class="block mb-2 font-medium">邮箱</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-envelope text-gray-400"></i>
                </span>
                <input type="email" id="register-email" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入邮箱">
              </div>
            </div>
            
            <div>
              <label for="register-password" class="block mb-2 font-medium">密码</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-lock text-gray-400"></i>
                </span>
                <input type="password" id="register-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入密码（至少6位）">
              </div>
            </div>
            
            <div>
              <label for="register-confirm-password" class="block mb-2 font-medium">确认密码</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-lock text-gray-400"></i>
                </span>
                <input type="password" id="register-confirm-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请再次输入密码">
              </div>
            </div>
            
            <div>
              <label for="register-security-question" class="block mb-2 font-medium">安全问题</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-question-circle text-gray-400"></i>
                </span>
                <select id="register-security-question" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent">
                  <option value="">请选择安全问题</option>
                  <option value="您的出生城市是？">您的出生城市是？</option>
                  <option value="您的小学名称是？">您的小学名称是？</option>
                  <option value="您的第一个宠物名字是？">您的第一个宠物名字是？</option>
                  <option value="您的母亲姓氏是？">您的母亲姓氏是？</option>
                  <option value="您的高中毕业年份是？">您的高中毕业年份是？</option>
                </select>
              </div>
            </div>
            
            <div>
              <label for="register-security-answer" class="block mb-2 font-medium">安全答案</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-key text-gray-400"></i>
                </span>
                <input type="text" id="register-security-answer" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入安全答案">
              </div>
            </div>
            
            <div>
              <label for="register-captcha" class="block mb-2 font-medium">验证码</label>
              <input type="text" id="register-captcha" class="form-input w-full mb-3 pl-4 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入验证码">
              <div class="flex justify-center">
                <canvas id="register-captcha-canvas" class="h-12 w-32 md:h-10 md:w-24 border border-gray-300 rounded-lg bg-light cursor-pointer"></canvas>
              </div>
            </div>
            
            <button id="register-button" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
              <i class="fa fa-user-plus mr-2"></i> 注册
            </button>
          </div>
          
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              已有账号？ <button id="switch-to-login" class="text-accent hover:underline font-medium">立即登录</button>
            </p>
          </div>
        </div>
        
        <!-- 忘记密码表单 -->
        <div id="forgot-password-form" class="p-6 hidden">
          <h2 class="text-2xl font-bold text-center mb-6 text-primary">忘记密码</h2>
          
          <div class="space-y-4">
            <div>
              <label for="forgot-username" class="block mb-2 font-medium">用户名</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-user text-gray-400"></i>
                </span>
                <input type="text" id="forgot-username" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入用户名">
              </div>
            </div>
            
            <div id="security-question-container" class="hidden">
              <label for="forgot-security-answer" class="block mb-2 font-medium">安全问题：<span id="security-question-text"></span></label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-key text-gray-400"></i>
                </span>
                <input type="text" id="forgot-security-answer" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入安全答案">
              </div>
            </div>
            
            <div id="new-password-container" class="hidden space-y-4">
              <div>
                <label for="reset-password" class="block mb-2 font-medium">新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fa fa-lock text-gray-400"></i>
                  </span>
                  <input type="password" id="reset-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入新密码（至少6位）">
                </div>
              </div>
              
              <div>
                <label for="reset-confirm-password" class="block mb-2 font-medium">确认新密码</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i class="fa fa-lock text-gray-400"></i>
                  </span>
                  <input type="password" id="reset-confirm-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请再次输入新密码">
                </div>
              </div>
            </div>
            
            <button id="forgot-password-button" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
              <i class="fa fa-search mr-2"></i> 验证用户
            </button>
            
            <button id="reset-password-button" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center hidden">
              <i class="fa fa-refresh mr-2"></i> 重置密码
            </button>
          </div>
          
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              想起密码了？ <button id="switch-to-login-from-forgot" class="text-accent hover:underline font-medium">返回登录</button>
            </p>
          </div>
        </div>
        
        <!-- 密码重置表单 -->
        <div id="reset-password-form" class="p-6 hidden">
          <h2 class="text-2xl font-bold text-center mb-6 text-primary">重置密码</h2>
          
          <div class="space-y-4">
            <div>
              <label for="reset-password" class="block mb-2 font-medium">新密码</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-lock text-gray-400"></i>
                </span>
                <input type="password" id="reset-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请输入新密码（至少6位）">
              </div>
            </div>
            
            <div>
              <label for="reset-confirm-password" class="block mb-2 font-medium">确认新密码</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                  <i class="fa fa-lock text-gray-400"></i>
                </span>
                <input type="password" id="reset-confirm-password" class="form-input w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg bg-light focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent" placeholder="请再次输入新密码">
              </div>
            </div>
            
            <button id="reset-password-button" class="w-full bg-primary hover:bg-accent text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
              <i class="fa fa-refresh mr-2"></i> 重置密码
            </button>
          </div>
          
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              取消重置？ <button id="switch-to-login-from-reset" class="text-accent hover:underline font-medium">返回登录</button>
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部信息 -->
  <footer class="bg-primary text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>© 2026 国际象棋游戏 | 支持AI自我学习的国际象棋网页应用</p>
    </div>
  </footer>

  <!-- 提示框 -->
  <div id="message-toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
    消息内容
  </div>

  <!-- 引入JavaScript文件 -->
  <script>
    // 当JavaScript启用时，显示页面内容
    document.addEventListener('DOMContentLoaded', function() {
      const pageContent = document.getElementById('page-content');
      if (pageContent) {
        pageContent.style.display = 'block';
      }
    });
  </script>
  <script src="js/userSystem.js"></script>

  <script>
    let userSystem;
    let captchaValues = {};
    
    // DOM加载完成后初始化
    document.addEventListener('DOMContentLoaded', async function() {
      
      
      // 初始化用户系统
      userSystem = new UserSystem();
      

      
      // 检查用户是否已登录
      if (userSystem.isLoggedIn()) {
        window.location.href = 'index.html';
      }
      
      // 检查URL是否包含密码重置令牌
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get('reset');
      if (resetToken) {
        // 由于我们现在使用安全问题进行密码重置，令牌不再有效
        showMessage('密码重置链接已过期，请使用安全问题重置密码', 'error');
        showTab('login');
        // 清除URL中的重置参数
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // 初始化验证码
      initCaptchas();
      
      // 标签页切换
      document.getElementById('login-tab').addEventListener('click', function() {
        showTab('login');
      });
      
      document.getElementById('register-tab').addEventListener('click', function() {
        showTab('register');
      });
      
      document.getElementById('switch-to-register').addEventListener('click', function() {
        showTab('register');
      });
      
      document.getElementById('switch-to-login').addEventListener('click', function() {
        showTab('login');
      });
      
      // 忘记密码链接点击事件
      document.querySelector('a[href="#"]').addEventListener('click', function(e) {
        e.preventDefault();
        showTab('forgot-password');
      });
      
      // 从忘记密码返回登录
      document.getElementById('switch-to-login-from-forgot').addEventListener('click', function() {
        showTab('login');
      });
      
      // 从密码重置返回登录
      document.getElementById('switch-to-login-from-reset').addEventListener('click', function() {
        showTab('login');
      });
      
      // 登录按钮点击事件
      document.getElementById('login-button').addEventListener('click', async function() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const captcha = document.getElementById('login-captcha').value.trim();
        
        if (!username || !password || !captcha) {
          showMessage('请填写所有必填字段', 'error');
          return;
        }
        
        // 验证验证码
        if (!validateCaptcha('login', captcha)) {
          showMessage('验证码错误', 'error');
          // 刷新验证码
          captchaValues.login = userSystem.drawCaptcha(document.getElementById('login-captcha-canvas'));
          document.getElementById('login-captcha').value = '';
          return;
        }
        
        try {
          const result = await userSystem.login(username, password);
          if (result.success) {
            showMessage('登录成功，正在跳转...', 'success');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 1000);
          } else {
            showMessage(result.message, 'error');
            // 刷新验证码
            captchaValues.login = userSystem.drawCaptcha(document.getElementById('login-captcha-canvas'));
            document.getElementById('login-captcha').value = '';
          }
        } catch (error) {
          showMessage('登录失败，请稍后重试', 'error');
          console.error('登录错误:', error);
          // 刷新验证码
          captchaValues.login = userSystem.drawCaptcha(document.getElementById('login-captcha-canvas'));
          document.getElementById('login-captcha').value = '';
        }
      });
      
      // 注册按钮点击事件
      document.getElementById('register-button').addEventListener('click', async function() {
        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        const securityQuestion = document.getElementById('register-security-question').value;
        const securityAnswer = document.getElementById('register-security-answer').value.trim();
        const captcha = document.getElementById('register-captcha').value.trim();
        
        if (!username || !email || !password || !confirmPassword || !securityQuestion || !securityAnswer || !captcha) {
          showMessage('请填写所有必填字段', 'error');
          return;
        }
        
        if (password !== confirmPassword) {
          showMessage('两次输入的密码不一致', 'error');
          return;
        }
        
        // 验证验证码
        if (!validateCaptcha('register', captcha)) {
          showMessage('验证码错误', 'error');
          // 刷新验证码
          captchaValues.register = userSystem.drawCaptcha(document.getElementById('register-captcha-canvas'));
          document.getElementById('register-captcha').value = '';
          return;
        }
        
        try {
          const result = await userSystem.register(username, password, email, securityQuestion, securityAnswer);
          if (result.success) {
            showMessage('注册成功，请登录', 'success');
            showTab('login');
          } else {
            showMessage(result.message, 'error');
            // 刷新验证码
            captchaValues.register = userSystem.drawCaptcha(document.getElementById('register-captcha-canvas'));
            document.getElementById('register-captcha').value = '';
          }
        } catch (error) {
          showMessage('注册失败，请稍后重试', 'error');
          console.error('注册错误:', error);
          // 刷新验证码
          captchaValues.register = userSystem.drawCaptcha(document.getElementById('register-captcha-canvas'));
          document.getElementById('register-captcha').value = '';
        }
      });
      
      // 忘记密码按钮点击事件
      document.getElementById('forgot-password-button').addEventListener('click', async function() {
        const username = document.getElementById('forgot-username').value.trim();
        const securityAnswer = document.getElementById('forgot-security-answer').value.trim();
        const newPassword = document.getElementById('reset-password').value;
        const confirmPassword = document.getElementById('reset-confirm-password').value;
        
        // 检查是否已经显示了安全问题
        const securityQuestionContainer = document.getElementById('security-question-container');
        const newPasswordContainer = document.getElementById('new-password-container');
        const resetPasswordButton = document.getElementById('reset-password-button');
        
        if (!securityQuestionContainer.classList.contains('hidden')) {
          // 验证安全答案
          if (!securityAnswer) {
            showMessage('请填写安全答案', 'error');
            return;
          }
          
          if (newPasswordContainer.classList.contains('hidden')) {
            // 安全答案正确，显示新密码输入框
            newPasswordContainer.classList.remove('hidden');
            resetPasswordButton.classList.remove('hidden');
            this.classList.add('hidden');
          } else {
            // 重置密码
            if (!newPassword || !confirmPassword) {
              showMessage('请填写新密码和确认密码', 'error');
              return;
            }
            
            if (newPassword !== confirmPassword) {
              showMessage('两次输入的密码不一致', 'error');
              return;
            }
            
            try {
              const result = await userSystem.verifySecurityAnswerAndResetPassword(username, securityAnswer, newPassword);
              if (result.success) {
                showMessage(result.message, 'success');
                // 显示成功提示后返回登录页
                setTimeout(() => {
                  showTab('login');
                }, 3000);
              } else {
                showMessage(result.message, 'error');
              }
            } catch (error) {
              showMessage('重置密码失败，请稍后重试', 'error');
              console.error('重置密码错误:', error);
            }
          }
        } else {
          // 验证用户名并显示安全问题
          if (!username) {
            showMessage('请填写用户名', 'error');
            return;
          }
          
          try {
            const result = await userSystem.getSecurityQuestion(username);
            if (result.success) {
              // 显示安全问题
              document.getElementById('security-question-text').textContent = result.question;
              securityQuestionContainer.classList.remove('hidden');
            } else {
              showMessage(result.message, 'error');
            }
          } catch (error) {
            showMessage('获取安全问题失败，请稍后重试', 'error');
            console.error('获取安全问题错误:', error);
          }
        }
      });
      
      // 密码重置按钮点击事件
      document.getElementById('reset-password-button').addEventListener('click', async function() {
        // 由于我们现在使用安全问题进行密码重置，此表单不再使用
        showMessage('请使用安全问题重置密码', 'error');
        showTab('forgot-password');
      });
      
      // 导入数据按钮点击事件 (登录页面)
      const authImportButton = document.getElementById('auth-import-data-button');
      console.log('Auth import button:', authImportButton);
      if (authImportButton) {
        authImportButton.addEventListener('click', function() {
          console.log('Auth import button clicked');
          const fileInput = document.getElementById('auth-import-file-input');
          console.log('Auth file input:', fileInput);
          if (confirm('导入数据将覆盖现有所有用户数据，确定要继续吗？')) {
            console.log('Opening file dialog');
            fileInput.click();
          }
        });
      }
      
      // 文件输入框change事件 (登录页面)
      const authImportFileInput = document.getElementById('auth-import-file-input');
      if (authImportFileInput) {
        authImportFileInput.addEventListener('change', async function(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          try {
            showMessage('正在导入数据...', 'info');
            
            // 读取文件内容
            const fileContent = await readFileAsText(file);
            const importData = JSON.parse(fileContent);
            
            // 导入数据
            const result = await userSystem.importUserData(importData);
            
            if (result.success) {
              showMessage('数据导入成功，页面将刷新', 'success');
              // 刷新页面以加载新数据
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              showMessage(result.message, 'error');
            }
          } catch (error) {
            console.error('导入数据失败:', error);
            showMessage('数据导入失败：' + error.message, 'error');
          } finally {
            // 清空文件输入框
            event.target.value = '';
          }
        });
      }
    });
    
    /**
     * 读取文件内容为文本
     * @param {File} file 文件对象
     * @returns {Promise<string>} 文件内容
     */
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => resolve(event.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsText(file);
      });
    }
    
    function showTab(tabName) {
      // 隐藏所有表单
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('forgot-password-form').classList.add('hidden');
      document.getElementById('reset-password-form').classList.add('hidden');
      
      // 移除所有标签的活动状态
      document.getElementById('login-tab').classList.remove('active');
      document.getElementById('register-tab').classList.remove('active');
      
      // 显示选中的表单
      document.getElementById(tabName + '-form').classList.remove('hidden');
      
      // 只激活登录和注册标签
      if (tabName === 'login' || tabName === 'register') {
        document.getElementById(tabName + '-tab').classList.add('active');
      }
    }
    
    // 显示消息
    function showMessage(message, type = 'info') {
      const toast = document.getElementById('message-toast');
      toast.textContent = message;
      
      // 设置不同类型的样式
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50';
      
      if (type === 'success') {
        toast.classList.add('bg-green-600', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-red-600', 'text-white');
      } else {
        toast.classList.add('bg-gray-800', 'text-white');
      }
      
      // 显示消息
      toast.style.opacity = '1';
      
      // 3秒后隐藏
      setTimeout(() => {
        toast.style.opacity = '0';
      }, 3000);
    }
    
    // 生成随机验证码
    function generateCaptcha() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let captcha = '';
      for (let i = 0; i < 4; i++) {
        captcha += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return captcha;
    }
    
    // 绘制验证码到画布
    function drawCaptcha(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // 清空画布
      ctx.clearRect(0, 0, width, height);
      
      // 绘制背景
      ctx.fillStyle = '#F5F5DC';
      ctx.fillRect(0, 0, width, height);
      
      // 生成验证码
      const captcha = generateCaptcha();
      
      // 绘制干扰线
      ctx.strokeStyle = '#D2B48C';
      ctx.lineWidth = 1;
      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * width, Math.random() * height);
        ctx.lineTo(Math.random() * width, Math.random() * height);
        ctx.stroke();
      }
      
      // 绘制干扰点
      ctx.fillStyle = '#CD853F';
      for (let i = 0; i < 20; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * width, Math.random() * height, 1, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // 根据Canvas高度动态调整字体大小
      const fontSize = Math.min(height * 0.45, 24);
      
      // 绘制验证码文字
      ctx.font = `${fontSize}px Arial`;
      ctx.fillStyle = '#8B4513';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // 每个字符随机位置
      for (let i = 0; i < captcha.length; i++) {
        const x = (width / captcha.length) * i + (width / captcha.length) / 2;
        const y = height / 2 + (Math.random() * height * 0.2 - height * 0.1);
        const rotation = (Math.random() * 20 - 10) * Math.PI / 180;
        
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotation);
        ctx.fillText(captcha[i], 0, 0);
        ctx.restore();
      }
      
      return captcha;
    }
    
    // 初始化验证码
    function initCaptchas() {
      // 检测是否为移动设备
      const isMobile = window.innerWidth < 768;
      
      // 初始化登录表单验证码
      const loginCanvas = document.getElementById('login-captcha-canvas');
      if (loginCanvas) {
        // 根据设备类型设置Canvas尺寸
        loginCanvas.width = isMobile ? 128 : 100;
        loginCanvas.height = isMobile ? 48 : 40;
        captchaValues.login = drawCaptcha(loginCanvas);
        
        // 添加点击刷新事件
        loginCanvas.addEventListener('click', function() {
          captchaValues.login = drawCaptcha(loginCanvas);
        });
      }
      
      // 初始化注册表单验证码
      const registerCanvas = document.getElementById('register-captcha-canvas');
      if (registerCanvas) {
        // 根据设备类型设置Canvas尺寸
        registerCanvas.width = isMobile ? 128 : 100;
        registerCanvas.height = isMobile ? 48 : 40;
        captchaValues.register = drawCaptcha(registerCanvas);
        
        // 添加点击刷新事件
        registerCanvas.addEventListener('click', function() {
          captchaValues.register = drawCaptcha(registerCanvas);
        });
      }
    }
    
    // 验证验证码
    function validateCaptcha(type, value) {
      if (!captchaValues[type]) {
        return false;
      }
      return captchaValues[type].toUpperCase() === value.toUpperCase();
    }
  </script>
  
  <!-- 用户系统和移动端导航功能 -->
  <script src="js/userSystem.js"></script>
  <script>
    // 处理用户登录状态
    document.addEventListener('DOMContentLoaded', async function() {
      const userSystem = new UserSystem();
      
      
      // 确保用户状态已经加载
      await userSystem.loadCurrentUserFromStorage();
      
      console.log('认证页 - 当前用户:', userSystem.getCurrentUser());
      console.log('认证页 - 是否登录:', userSystem.isLoggedIn());
      
      // 检查用户登录状态
      if (userSystem.isLoggedIn()) {
        const user = userSystem.getCurrentUser();
        console.log('认证页 - 用户已登录:', user.username);
        
        // 桌面端菜单
        document.getElementById('user-auth').classList.add('hidden');
        document.getElementById('user-profile').classList.remove('hidden');
        document.getElementById('username-display').textContent = user.username;
        
        // 移动端菜单
        document.getElementById('mobile-user-auth').classList.add('hidden');
        document.getElementById('mobile-user-profile').classList.remove('hidden');
        document.getElementById('mobile-username-display').textContent = user.username;
      } else {
        console.log('认证页 - 用户未登录');
        
        // 桌面端菜单
        document.getElementById('user-auth').classList.remove('hidden');
        document.getElementById('user-profile').classList.add('hidden');
        
        // 移动端菜单
        document.getElementById('mobile-user-auth').classList.remove('hidden');
        document.getElementById('mobile-user-profile').classList.add('hidden');
      }
      
      // 桌面端登出按钮点击事件
      document.getElementById('logout-button').addEventListener('click', async function() {
        await userSystem.logout();
        window.location.reload();
      });
      
      // 移动端登出按钮点击事件
      document.getElementById('mobile-logout-button').addEventListener('click', async function() {
        await userSystem.logout();
        window.location.reload();
      });
      
      // 移动端菜单按钮点击事件
      document.getElementById('mobile-menu-button').addEventListener('click', function() {
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenu.classList.toggle('hidden');
      });
    });
  </script>
  </div>
</body>
</html>